# 前端手机号登录接入文档

本文档描述了如何接入手机号 + 验证码的注册/登录功能，包含行为验证码（AJ-Captcha）的集成流程。

## 1. 交互流程概览

1.  **输入手机号**：用户在界面输入手机号。
2.  **触发验证码**：用户点击“发送验证码”按钮，**首先弹出行为验证码（滑动拼图）**。
3.  **行为验证通过**：用户滑动成功后，行为验证码组件会返回一个加密的 `captchaVerification` 字符串。
4.  **发送短信请求**：前端将 `phone` 和 `captchaVerification` 一并发送给后端接口 `/api/user/captcha/sms`。
5.  **接收短信**：后端校验通过后发送短信，前端开启 60s 倒计时。
6.  **登录注册**：用户输入收到的短信验证码，点击登录，前端调用 `/api/user/login/phone` 完成登录（未注册用户会自动注册）。

## 2. 接口定义

### 2.1 获取行为验证码数据 (内部接口)
> 通常由 AJ-Captcha SDK 内部调用，开发者无需手动调用，但需配置 SDK 请求地址。

*   **URL**: `/api/user/captcha/fetch` (注意：原 `/captcha/get` 已重命名)
*   **Method**: `POST`

### 2.2 行为验证码二次校验 & 发送短信
*   **URL**: `/api/user/captcha/sms`
*   **Method**: `POST`
*   **Content-Type**: `application/json`
*   **请求参数**:

| 参数名 | 类型 | 必选 | 说明 |
| :--- | :--- | :--- | :--- |
| `phone` | string | 是 | 用户输入的手机号 |
| `captchaVerification` | string | 是 | 滑动拼图成功后返回的二次校验加密串 |

*   **响应示例**:
```json
{
    "code": 0,
    "data": true,
    "message": "ok"
}
```

### 2.3 手机号一键登录/注册
*   **URL**: `/api/user/login/phone`
*   **Method**: `POST`
*   **Content-Type**: `application/json`
*   **请求参数**:

| 参数名 | 类型 | 必选 | 说明 |
| :--- | :--- | :--- | :--- |
| `phone` | string | 是 | 手机号 |
| `captcha` | string | 是 | 收到的 6 位短信验证码 |

*   **响应示例** (成功登录返回用户信息):
```json
{
  "code": 0,
  "data": {
    "id": "18827364...",
    "userName": "user_xxxx",
    "userRole": "user",
    "phone": "13800138000",
    ...
  },
  "message": "ok"
}
```

## 3. 前端接入 (React/Vue 示例思路)

### 3.1 引入 AJ-Captcha 客户端 SDK
假设您使用的是 Web 端，需确保引入了 `verifition` 相关组件或 JS。
参考 AJ-Captcha 官方文档或项目中的资源文件。

### 3.2 伪代码逻辑

```javascript
// 1. 定义发送验证码的方法（绑定到按钮点击事件）
async function handleSendSms() {
    // 校验手机号格式
    if (!validatePhone(phone.value)) {
        alert("请输入正确的手机号");
        return;
    }

    // 唤起行为验证码组件
    // 注意：这里需要配置 AJ-Captcha 的后端接口地址为 /api/user/captcha/fetch
    captchaRef.value.verify(); 
}

// 2. 行为验证码成功回调 (AJ-Captcha 提供的回调钩子)
async function onCaptchaSuccess(params) {
    // params.captchaVerification 就是我们需要的数据
    const verifyCode = params.captchaVerification;
    
    try {
        // 调用后端发送短信接口
        const res = await request.post('/api/user/captcha/sms', {
            phone: phone.value,
            captchaVerification: verifyCode
        });

        if (res.code === 0) {
            alert("短信发送成功");
            startCountDown(); // 开启倒计时
        } else {
            alert(res.message);
        }
    } catch (e) {
        console.error(e);
        alert("发送失败");
    }
}

// 3. 登录按钮逻辑
async function handleLogin() {
    if (!smsCode.value) {
        alert("请输入验证码");
        return;
    }

    const res = await request.post('/api/user/login/phone', {
        phone: phone.value,
        captcha: smsCode.value
    });

    if (res.code === 0) {
        // 登录成功，保存 token/用户信息，跳转首页
        saveUser(res.data);
        router.push('/');
    } else {
        alert(res.message || "登录失败");
    }
}
```

## 4. 注意事项

1.  **接口地址变更**: AJ-Captcha 默认的获取验证码接口是 `/captcha/get`，但为了避免与后端框架冲突，本项目已重名为 **`/api/user/captcha/fetch`**。请务必在前端 SDK 配置中修改 `requestUrl` 或 `baseUrl`。
2.  **防抖与节流**: 登录按钮建议添加防抖，防止用户连续点击。
3.  **错误处理**: 如果行为验证通过但短信发送失败（如频率限制），需要提示用户并重置图形验证码状态。
